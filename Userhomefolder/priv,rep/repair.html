<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecodrive - Repair Booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="repair.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">ECODRIVE</div>

        <div class="nav-right">
            <ul class="nav-links">
                <li><a href="../userhome.html">Home</a></li>
                <li><a href="../bookings/bookings.html">Bookings</a></li>
                <li><a href="../userhome2.html">Ebikes Products</a></li>
                <li><a href="../contact/contact.html">Contact</a></li>
                <li><a href="repair.html" class="active">Repair Booking</a></li>
            </ul>

            <div class="profile-menu">
                <button type="button" class="profile-btn" aria-label="Open profile menu">
                    <img src="../userhomelogo.jpg" alt="Profile">
                </button>

                <div class="dropdown" aria-label="Profile menu">
                    <a href="../../Usersetting.html/settings.html">Account</a>
                    <a href="../../Usersetting.html/settings.html#orderSection">Order Status</a>
                    <a href="../../log in.html">Log Out</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="repair-main">
        <h1 class="page-title">Repair Booking Form <span aria-hidden="true">&#128736;</span></h1>

        <section class="repair-card" aria-label="Repair booking form container">
            <form id="repair-form" novalidate>
                <div class="form-grid">
                    <div class="left-col">
                        <label for="repair-name">Name</label>
                        <input id="repair-name" name="name" type="text" placeholder="Enter your name" required>

                        <label for="repair-email">Email</label>
                        <input id="repair-email" name="email" type="email" placeholder="Enter your email" required>

                        <label for="repair-phone">Phone Number</label>
                        <input id="repair-phone" name="phone" type="tel" placeholder="09XXXXXXXXX" required>

                        <label for="repair-vehicle">Type of Vehicle</label>
                        <select id="repair-vehicle" name="vehicle" required>
                            <option value="">Select e-bike model</option>
                            <optgroup label="2-Wheel">
                                <option value="BLITZ 2000">BLITZ 2000</option>
                                <option value="BLITZ 1200">BLITZ 1200</option>
                                <option value="FUN 1500 FI">FUN 1500 FI</option>
                                <option value="CANDY 800">CANDY 800</option>
                                <option value="BLITZ 200R">BLITZ 200R</option>
                                <option value="TRAVELLER 1500">TRAVELLER 1500</option>
                                <option value="ECONO 500 MP">ECONO 500 MP</option>
                                <option value="ECONO 350 MINI-II">ECONO 350 MINI-II</option>
                            </optgroup>
                            <optgroup label="3-Wheel">
                                <option value="ECARGO 100">ECARGO 100</option>
                                <option value="ECONO 650 MP">ECONO 650 MP</option>
                                <option value="ECAB 100V V2">ECAB 100V V2</option>
                                <option value="ECONO 800 MP II">ECONO 800 MP II</option>
                            </optgroup>
                            <optgroup label="4-Wheel">
                                <option value="E-CARGO 800">E-CARGO 800</option>
                                <option value="E-CAB MAX 1500">E-CAB MAX 1500</option>
                                <option value="E-CAB 1000">E-CAB 1000</option>
                                <option value="ECONO 800 MP">ECONO 800 MP</option>
                            </optgroup>
                        </select>

                        <div class="date-time-row">
                            <div class="input-col">
                                <label for="repair-date">Date</label>
                                <input id="repair-date" name="date" type="date" required>
                            </div>

                            <div class="input-col">
                                <label for="repair-time">Time</label>
                                <input id="repair-time" name="time" type="time" required>
                            </div>
                        </div>
                    </div>

                    <div class="right-col">
                        <div class="service-options" role="radiogroup" aria-label="Service type">
                            <label class="service-choice">
                                <input type="radio" name="service" value="Walk in" checked>
                                <span class="service-radio" aria-hidden="true"></span>
                                <span class="service-tag">Walk in</span>
                            </label>

                            <label class="service-choice">
                                <input type="radio" name="service" value="Home Service">
                                <span class="service-radio" aria-hidden="true"></span>
                                <span class="service-tag">Home Service</span>
                            </label>
                        </div>

                        <label for="repair-details" class="details-label">Please provide further information about what went wrong</label>
                        <textarea id="repair-details" name="details" placeholder="Describe the issue" required></textarea>
                    </div>
                </div>

                <div class="actions-row">
                    <button type="submit" class="book-btn">Book Now</button>
                </div>

                <p id="repair-message" class="repair-message" aria-live="polite"></p>
            </form>
        </section>
    </main>

    <button type="button" class="chatbot" id="chatbot-toggle" aria-label="Open chatbot">&#129302;</button>

    <section class="chat-panel" id="chat-panel" aria-hidden="true">
        <header class="chat-header">
            <strong>Ecodrive Bot</strong>
            <button type="button" id="chat-close" aria-label="Close chat">x</button>
        </header>
        <div class="chat-body" id="chat-body"></div>
        <form class="chat-form" id="chat-form" action="#">
            <input type="text" id="chat-input" placeholder="Type your message">
            <button type="submit">Send</button>
        </form>
    </section>

    <script src="../../session.js"></script>
    <script src="../chatbot-brain.js"></script>
    <script>
        (function () {
            const profileBtn = document.querySelector('.profile-btn');
            const dropdown = document.querySelector('.dropdown');
            const form = document.getElementById('repair-form');
            const message = document.getElementById('repair-message');
            const nameInput = document.getElementById('repair-name');
            const emailInput = document.getElementById('repair-email');
            const phoneInput = document.getElementById('repair-phone');
            const currentUserKey = 'ecodrive_current_user_email';
            const usersKey = 'users';
            const repairStorageKey = 'ecodrive_repair_bookings';
            const bookingStorageKeys = ['ecodrive_bookings', 'ecodrive_orders', 'orders'];
            const API_BASE = String(
                localStorage.getItem('ecodrive_api_base') ||
                localStorage.getItem('ecodrive_kyc_api_base') ||
                (window.EcodriveSession && typeof window.EcodriveSession.getApiBase === 'function'
                    ? window.EcodriveSession.getApiBase()
                    : '')
            ).trim().replace(/\/+$/, '');

            if (profileBtn && dropdown) {
                profileBtn.addEventListener('click', function (event) {
                    event.stopPropagation();
                    dropdown.classList.toggle('show');
                });

                dropdown.addEventListener('click', function (event) {
                    event.stopPropagation();
                });

                document.addEventListener('click', function () {
                    dropdown.classList.remove('show');
                });
            }

            function safeParse(raw) {
                try {
                    return JSON.parse(raw);
                } catch (_error) {
                    return null;
                }
            }

            function getApiUrl(path) {
                return API_BASE ? API_BASE + path : path;
            }

            function normalizePhoneValue(phone) {
                const cleaned = String(phone || '').trim().replace(/[\s-]/g, '');
                if (/^\+639\d{9}$/.test(cleaned)) {
                    return '0' + cleaned.slice(3);
                }
                if (/^639\d{9}$/.test(cleaned)) {
                    return '0' + cleaned.slice(2);
                }
                return cleaned;
            }

            function isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
            }

            function isValidPhone(phone) {
                return /^09\d{9}$/.test(String(phone || '').trim());
            }

            function getCurrentUserEmail() {
                const localEmail = (localStorage.getItem(currentUserKey) || '').trim().toLowerCase();
                if (localEmail) {
                    return localEmail;
                }
                return (sessionStorage.getItem(currentUserKey) || '').trim().toLowerCase();
            }

            function getProfileStorageKey(emailValue) {
                const email = String(emailValue || '').trim().toLowerCase();
                return email ? 'ecodrive_profile_settings::' + email : 'ecodrive_profile_settings';
            }

            function getUsers() {
                const parsed = safeParse(localStorage.getItem(usersKey));
                return Array.isArray(parsed) ? parsed : [];
            }

            function getCurrentUserFromUsers(emailValue) {
                const email = String(emailValue || '').trim().toLowerCase();
                if (!email) {
                    return null;
                }

                const users = getUsers();
                return users.find(function (user) {
                    return String((user && user.email) || '').trim().toLowerCase() === email;
                }) || null;
            }

            function buildNameFromUser(user) {
                if (!user || typeof user !== 'object') {
                    return '';
                }

                if (user.name) {
                    return String(user.name).trim();
                }

                const first = String(user.firstName || '').trim();
                const middle = String(user.middleInitial || '').trim();
                const last = String(user.lastName || '').trim();
                const middleWithDot = middle ? middle.replace(/\.+$/, '') + '.' : '';
                return [first, middleWithDot, last].filter(Boolean).join(' ').trim();
            }

            function getCurrentUserProfile() {
                const currentEmail = getCurrentUserEmail();
                const user = getCurrentUserFromUsers(currentEmail);
                const scopedProfile = safeParse(localStorage.getItem(getProfileStorageKey(currentEmail)));
                const legacyProfile = safeParse(localStorage.getItem('ecodrive_profile_settings'));
                const profile = (scopedProfile && typeof scopedProfile === 'object')
                    ? scopedProfile
                    : ((legacyProfile && typeof legacyProfile === 'object') ? legacyProfile : {});

                return {
                    fullName: String(profile.fullName || profile.name || buildNameFromUser(user) || '').trim(),
                    email: String(profile.email || (user && user.email) || currentEmail || '').trim().toLowerCase(),
                    phone: normalizePhoneValue(profile.phone || (user && user.phone) || '')
                };
            }

            function seedUserDefaults() {
                const profile = getCurrentUserProfile();
                if (nameInput && profile.fullName && !nameInput.value) {
                    nameInput.value = profile.fullName;
                }
                if (emailInput && profile.email && !emailInput.value) {
                    emailInput.value = profile.email;
                }
                if (phoneInput && profile.phone && !phoneInput.value) {
                    phoneInput.value = profile.phone;
                }
            }

            function appendRecordToStorage(storageKey, record) {
                const parsed = safeParse(localStorage.getItem(storageKey));
                const list = Array.isArray(parsed) ? parsed : [];
                list.push(record);
                localStorage.setItem(storageKey, JSON.stringify(list));
            }

            async function saveBookingToApi(record) {
                try {
                    const response = await fetch(getApiUrl('/api/bookings'), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(record)
                    });

                    if (response.status === 404 || response.status === 405) {
                        return false;
                    }

                    const payload = await response.json().catch(function () {
                        return {};
                    });
                    return response.ok && payload && payload.success === true;
                } catch (_error) {
                    return false;
                }
            }

            async function saveRepairBooking(record) {
                const apiSaved = await saveBookingToApi(record);

                appendRecordToStorage(repairStorageKey, record);
                localStorage.setItem('latestRepairBooking', JSON.stringify(record));

                if (apiSaved) {
                    return;
                }

                bookingStorageKeys.forEach(function (key) {
                    appendRecordToStorage(key, record);
                });
                localStorage.setItem('latestBooking', JSON.stringify(record));
            }

            function setMessage(text, isError) {
                if (!message) return;
                message.textContent = text;
                message.classList.toggle('error', !!isError);
            }

            if (form) {
                form.addEventListener('submit', async function (event) {
                    event.preventDefault();
                    setMessage('', false);

                    const formData = new FormData(form);
                    const normalizedPhone = normalizePhoneValue(formData.get('phone'));
                    const recordId = 'REP-' + Date.now();
                    const accountEmail = getCurrentUserEmail();
                    const formEmail = String(formData.get('email') || '').trim().toLowerCase();
                    const bookingEmail = accountEmail || formEmail;
                    const payload = {
                        orderId: recordId,
                        id: recordId,
                        fullName: String(formData.get('name') || '').trim(),
                        name: String(formData.get('name') || '').trim(),
                        email: bookingEmail,
                        phone: normalizedPhone,
                        model: String(formData.get('vehicle') || '').trim(),
                        vehicle: String(formData.get('vehicle') || '').trim(),
                        appointmentDate: String(formData.get('date') || '').trim(),
                        appointmentTime: String(formData.get('time') || '').trim(),
                        date: String(formData.get('date') || '').trim(),
                        time: String(formData.get('time') || '').trim(),
                        service: String(formData.get('service') || 'Walk in').trim(),
                        payment: 'REPAIR',
                        subtotal: 0,
                        shippingFee: 0,
                        total: 0,
                        details: String(formData.get('details') || '').trim(),
                        userEmail: accountEmail || bookingEmail,
                        status: 'Pending review',
                        fulfillmentStatus: 'Awaiting Inspection',
                        createdAt: new Date().toISOString()
                    };

                    if (!payload.fullName || !payload.email || !payload.phone || !payload.model || !payload.date || !payload.time || !payload.details) {
                        setMessage('Please complete all required fields.', true);
                        return;
                    }
                    if (!isValidEmail(payload.email)) {
                        setMessage('Please enter a valid email address.', true);
                        return;
                    }
                    if (!isValidPhone(payload.phone)) {
                        setMessage('Please enter a valid phone number (09XXXXXXXXX).', true);
                        return;
                    }

                    await saveRepairBooking(payload);
                    form.reset();
                    const defaultService = form.querySelector('input[name="service"][value="Walk in"]');
                    if (defaultService) defaultService.checked = true;
                    seedUserDefaults();
                    setMessage('Repair booking submitted successfully.', false);
                });
            }

            seedUserDefaults();

            const botToggle = document.getElementById('chatbot-toggle');
            const chatPanel = document.getElementById('chat-panel');
            const chatClose = document.getElementById('chat-close');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatBody = document.getElementById('chat-body');
            const chatKey = 'ecodrive_chat_messages_v1';
            const smartReply = (window.EcodriveChatbotBrain && typeof window.EcodriveChatbotBrain.createResponder === 'function')
                ? window.EcodriveChatbotBrain.createResponder()
                : null;
            let chatMessages = [];

            try {
                const parsed = JSON.parse(localStorage.getItem(chatKey) || '[]');
                if (Array.isArray(parsed)) chatMessages = parsed;
            } catch (_error) {
                chatMessages = [];
            }

            if (chatMessages.length === 0) {
                chatMessages = [{ from: 'bot', text: "Hi! I'm Ecodrive Bot. Ask me about Ecodrive ebikes, prices, booking status, payment, or repair." }];
                localStorage.setItem(chatKey, JSON.stringify(chatMessages));
            }

            function renderMessages() {
                if (!chatBody) return;
                chatBody.innerHTML = '';
                chatMessages.forEach(function (entry) {
                    const bubble = document.createElement('div');
                    bubble.className = 'chat-bubble ' + (entry.from === 'user' ? 'user' : 'bot');
                    bubble.textContent = entry.text;
                    chatBody.appendChild(bubble);
                });
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            function saveMessages() {
                localStorage.setItem(chatKey, JSON.stringify(chatMessages));
            }

            function openChat() {
                if (!chatPanel) return;
                chatPanel.classList.add('open');
                chatPanel.setAttribute('aria-hidden', 'false');
                renderMessages();
                if (chatInput) chatInput.focus();
            }

            function closeChat() {
                if (!chatPanel) return;
                chatPanel.classList.remove('open');
                chatPanel.setAttribute('aria-hidden', 'true');
            }

            function getBotReply(text) {
                if (smartReply) return smartReply(text);
                return 'I can help with ebike models, prices, booking status, payment, installment, delivery, and repair.';
            }

            if (botToggle) {
                botToggle.addEventListener('click', function () {
                    if (!chatPanel) return;
                    if (chatPanel.classList.contains('open')) closeChat();
                    else openChat();
                });
            }

            if (chatClose) {
                chatClose.addEventListener('click', closeChat);
            }

            if (chatForm) {
                chatForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const text = (chatInput && chatInput.value ? chatInput.value : '').trim();
                    if (!text) return;

                    chatMessages.push({ from: 'user', text: text });
                    chatMessages.push({ from: 'bot', text: getBotReply(text) });
                    saveMessages();
                    renderMessages();
                    if (chatInput) chatInput.value = '';
                });
            }

            renderMessages();
        })();
    </script>
</body>
</html>


